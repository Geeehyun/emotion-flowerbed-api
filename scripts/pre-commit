#!/bin/bash
#
# Git pre-commit hook - 민감정보 검증
# 커밋 전에 자동으로 실행되어 민감정보 포함 여부를 검사합니다.
#

echo "🔍 민감정보 검증 중..."

# 커밋될 파일 목록
files=$(git diff --cached --name-only --diff-filter=ACM)

# 검증 실패 플래그
failed=0

# 민감정보 패턴 정의
declare -A patterns=(
    ["Anthropic API Key"]="sk-ant-api03-[A-Za-z0-9_-]{95,}"
    ["OpenAI API Key"]="sk-[A-Za-z0-9]{20,}"
    ["AWS Access Key"]="AKIA[0-9A-Z]{16}"
    ["Private Key"]="-----BEGIN (RSA |EC )?PRIVATE KEY-----"
    ["Password (common)"]="password\s*[:=]\s*['\"][^'\"]{8,}['\"]"
    ["JWT Secret (base64)"]="secret[-_]?key\s*[:=]\s*['\"][A-Za-z0-9+/=]{32,}['\"]"
    ["Database Password"]="(SPRING_DATASOURCE_PASSWORD|DB_PASSWORD|password)\s*[:=]\s*['\"](?!1234|root|password|test)[^'\"]{6,}['\"]"
)

# RDS 엔드포인트 패턴 (실제 운영 DB 주소)
RDS_PATTERN="emotion-flowerbed-database-mariadb\.cd0yu0kwwyk2\.ap-northeast-2\.rds\.amazonaws\.com"

# Private IP 패턴 (EC2 내부 IP)
PRIVATE_IP_PATTERN="172\.31\.[0-9]{1,3}\.[0-9]{1,3}"

echo ""
echo "📁 검증 대상 파일:"
echo "$files" | sed 's/^/  - /'
echo ""

for file in $files; do
    # .gitignore에 포함된 파일은 검증하지 않음
    if git check-ignore -q "$file"; then
        continue
    fi

    # 파일이 존재하지 않으면 스킵 (삭제된 파일)
    if [ ! -f "$file" ]; then
        continue
    fi

    # 민감정보 패턴 검사
    for pattern_name in "${!patterns[@]}"; do
        pattern="${patterns[$pattern_name]}"

        # grep으로 패턴 검색 (Perl 정규식 사용)
        if grep -qPi "$pattern" "$file" 2>/dev/null; then
            echo "❌ $file"
            echo "   → 발견: $pattern_name"
            echo "   → 패턴: $pattern"
            echo ""
            failed=1
        fi
    done

    # RDS 엔드포인트 검사 (application.yml 제외)
    if [[ "$file" != *"application.yml"* ]] && [[ "$file" != *"application-"*".yml"* ]]; then
        if grep -qi "$RDS_PATTERN" "$file" 2>/dev/null; then
            echo "❌ $file"
            echo "   → 발견: RDS 엔드포인트 (운영 DB 주소)"
            echo ""
            failed=1
        fi
    fi

    # Private IP 검사 (특정 파일 제외)
    if [[ "$file" != *"application.yml"* ]] && [[ "$file" != *"README"* ]]; then
        if grep -qP "$PRIVATE_IP_PATTERN" "$file" 2>/dev/null; then
            echo "⚠️  $file"
            echo "   → 발견: Private IP 주소 (EC2 내부 IP)"
            echo ""
            # Private IP는 경고만 (failed=1 안함)
        fi
    fi
done

if [ $failed -eq 1 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🚨 커밋 거부: 민감정보가 포함되어 있습니다!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "해결 방법:"
    echo "  1. 하드코딩된 민감정보를 환경변수 참조로 변경"
    echo "     예: password: \${SPRING_DATASOURCE_PASSWORD}"
    echo ""
    echo "  2. 민감정보가 포함된 파일을 .gitignore에 추가"
    echo ""
    echo "  3. 검증을 무시하고 커밋하려면 (권장하지 않음):"
    echo "     git commit --no-verify"
    echo ""
    exit 1
fi

echo "✅ 민감정보 검증 통과!"
echo ""
exit 0
